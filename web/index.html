<!DOCTYPE html><html><head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Send iMessages on Web using BlueBubbles!">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta http-equiv="X-Robots-Tag" content="noindex, nofollow">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="BlueBubbles">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Google auth details -->
  <meta name="google-signin-client_id" content="500464701389-8trcdkcj7ni5l4dn6n7l795rhb1asnh3.apps.googleusercontent.com">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="icons/favicon.ico">

  <!-- Apple MapKit JS Library -->
  <script
    src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.core.js"
    crossorigin="anonymous"
    data-libraries="map,annotations,services">
  </script>

  <!-- MapKit Initialization Helper -->
  <script>
    console.log('[MapKit Setup] Initialization script loaded');

    // CRITICAL: This prevents "mapkit is not defined" and "$1 is not a function" errors
    window.mapKitLoaded = false;
    window.mapKitCallbacks = [];

    // Poll for MapKit availability since it loads asynchronously
    (function checkMapKit() {
      if (window.mapkit && window.mapkit.init) {
        console.log('[MapKit] Library detected and ready');
        window.mapKitLoaded = true;
        window.mapKitCallbacks.forEach(cb => cb());
        window.mapKitCallbacks = [];
      } else {
        console.log('[MapKit] Still waiting for library...');
        setTimeout(checkMapKit, 100); // Check every 100ms
      }
    })();

    // Helper function for Flutter code to use
    // This is what event_map_widget.dart calls via js.context.callMethod('whenMapKitReady', ...)
    window.whenMapKitReady = function(callback) {
      console.log('[MapKit] whenMapKitReady called, loaded:', window.mapKitLoaded);
      if (window.mapKitLoaded) {
        callback();
      } else {
        window.mapKitCallbacks.push(callback);
      }
    };
  </script>

  <title>BlueBubbles</title>
  <link rel="manifest" href="manifest.json">

  <script>
    // The value below is injected by flutter build, do not touch.
    const serviceWorkerVersion = '{{flutter_service_worker_version}}';
  </script>
  <!-- This script adds the flutter initialization JS code -->
  <script src="flutter.js" defer=""></script>
  
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
  
  <style id="splash-screen-style">
    html {
      height: 100%
    }

    body {
      margin: 0;
      min-height: 100%;
      background-color: #FFFFFF;
          background-size: 100% 100%;
    }

    .center {
      margin: 0;
      position: absolute;
      top: 50%;
      left: 50%;
      -ms-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
    }

    .contain {
      display:block;
      width:100%; height:100%;
      object-fit: contain;
    }

    .stretch {
      display:block;
      width:100%; height:100%;
    }

    .cover {
      display:block;
      width:100%; height:100%;
      object-fit: cover;
    }

    .bottom {
      position: absolute;
      bottom: 0;
      left: 50%;
      -ms-transform: translate(-50%, 0);
      transform: translate(-50%, 0);
    }

    .bottomLeft {
      position: absolute;
      bottom: 0;
      left: 0;
    }

    .bottomRight {
      position: absolute;
      bottom: 0;
      right: 0;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background-color: #000000;
          }
    }
  </style>
  <script id="splash-screen-script">
    function removeSplashFromWeb() {
      document.getElementById("splash")?.remove();
      document.getElementById("splash-branding")?.remove();
      document.body.style.background = "transparent";
    }
  </script>
</head>
<body>
  <picture id="splash">
      <source srcset="splash/img/light-1x.png 1x, splash/img/light-2x.png 2x, splash/img/light-3x.png 3x, splash/img/light-4x.png 4x" media="(prefers-color-scheme: light)">
      <source srcset="splash/img/dark-1x.png 1x, splash/img/dark-2x.png 2x, splash/img/dark-3x.png 3x, splash/img/dark-4x.png 4x" media="(prefers-color-scheme: dark)">
      <img class="center" aria-hidden="true" src="splash/img/light-1x.png" alt="">
  </picture>
  
  <script>
    function showInitializationError(message) {
      removeSplashFromWeb();

      let errorContainer = document.getElementById('flutter-init-error');

      if (!errorContainer) {
        errorContainer = document.createElement('div');
        errorContainer.id = 'flutter-init-error';
        errorContainer.style.cssText = [
          'position: fixed',
          'inset: 0',
          'display: flex',
          'align-items: center',
          'justify-content: center',
          'background: #0b0b0f',
          'color: #f5f5f7',
          'padding: 24px',
          'text-align: center',
          'font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
        ].join(';');

        const messageBox = document.createElement('div');
        messageBox.style.cssText = [
          'max-width: 640px',
          'background: rgba(255, 255, 255, 0.04)',
          'border: 1px solid rgba(255, 255, 255, 0.12)',
          'border-radius: 12px',
          'padding: 24px',
          'box-shadow: 0 12px 48px rgba(0, 0, 0, 0.28)',
        ].join(';');

        const title = document.createElement('h2');
        title.textContent = 'BlueBubbles failed to load';
        title.style.margin = '0 0 12px 0';

        const body = document.createElement('p');
        body.id = 'flutter-init-error-message';
        body.style.margin = '0';

        messageBox.appendChild(title);
        messageBox.appendChild(body);
        errorContainer.appendChild(messageBox);
        document.body.appendChild(errorContainer);
      }

      const messageElement = document.getElementById('flutter-init-error-message');
      if (messageElement) {
        messageElement.textContent = message;
      }
    }

    window.addEventListener('load', function () {
      const loader = window._flutter?.loader;
      if (!loader) {
        console.error('Flutter loader not found. Ensure flutter.js is loaded.');
        showInitializationError('BlueBubbles could not start because a required file failed to load. Please refresh the page or try a different browser.');
        return;
      }

      loader
        .loadEntrypoint({
          serviceWorker: {
            serviceWorkerVersion: serviceWorkerVersion,
          },
          onEntrypointLoaded: function (engineInitializer) {
            const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
              navigator.userAgent || ''
            );

            const supportsWebGL = (() => {
              try {
                const canvas = document.createElement('canvas');
                return !!(canvas.getContext('webgl2') || canvas.getContext('webgl'));
              } catch (_) {
                return false;
              }
            })();

            const preferHtmlRenderer = isMobileDevice || !supportsWebGL;

            const rendererConfig = preferHtmlRenderer
              ? { renderer: 'html', useColorEmoji: true }
              : { renderer: 'canvaskit', useColorEmoji: true };

            engineInitializer
              .initializeEngine(rendererConfig)
              .then(function (appRunner) {
                removeSplashFromWeb();
                appRunner.runApp();
              })
              .catch(function (err) {
                console.error('Failed to initialize Flutter engine', err);
                showInitializationError('BlueBubbles could not start because your browser is missing required capabilities. Please refresh the page or try a different device or browser.');
              });
          },
        })
        .catch(function (err) {
          console.error('Failed to load Flutter entrypoint', err);
          showInitializationError('BlueBubbles could not start because critical resources failed to load. Please refresh the page and try again.');
        });
    });
  </script>


</body></html>